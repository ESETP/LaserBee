C51 COMPILER V9.60.0.0   FUNCTION_GENERATOR                                                01/22/2022 21:08:33 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE FUNCTION_GENERATOR
OBJECT MODULE PLACED IN .\src\function_generator.OBJ
COMPILER INVOKED BY: C:\SiliconLabs\SimplicityStudio\v5\developer\toolchains\keil_8051\9.60\BIN\C51.exe C:\Users\markh\O
                    -neDrive\Documents\Uni\4th Year\Eng\EE4\LaserBee\LaserBeeAudio\src\function_generator.c OMF2 SMALL DEBUG OBJECTEXTEND ROM
                    -(LARGE) WARNINGLEVEL(2) FLOATFUZZY(3) OPTIMIZE(8,SPEED) DEFINE(DEBUG=1) INTVECTOR(0X0000) INTPROMOTE INCDIR(C:\Users\mar
                    -kh\OneDrive\Documents\Uni\4th Year\Eng\EE4\LaserBee\LaserBeeAudio\inc;C:\Users\markh\OneDrive\Documents\Uni\4th Year\Eng
                    -\EE4\LaserBee\LaserBeeAudio\inc\config;C:\Users\markh\OneDrive\Documents\Uni\4th Year\Eng\EE4\LaserBee\LaserBeeAudio\inc
                    -\graphics;C:/SiliconLabs/SimplicityStudio/v5/developer/sdks/8051/v4.2.3//Device/EFM8LB1/peripheral_driver/inc;C:/Silicon
                    -Labs/SimplicityStudio/v5/developer/sdks/8051/v4.2.3//kits/common/drivers/efm8_joystick;C:/SiliconLabs/SimplicityStudio/v
                    -5/developer/sdks/8051/v4.2.3//kits/common/bsp;C:/SiliconLabs/SimplicityStudio/v5/developer/sdks/8051/v4.2.3//kits/EFM8LB
                    -1_SLSTK2030A/config;C:/SiliconLabs/SimplicityStudio/v5/developer/sdks/8051/v4.2.3//kits/common/drivers/efm8_retargetseri
                    -al;C:/SiliconLabs/SimplicityStudio/v5/developer/sdks/8051/v4.2.3//Device/shared/si8051Base;C:/SiliconLabs/SimplicityStud
                    -io/v5/developer/sdks/8051/v4.2.3//Device/EFM8LB1/inc;C:/SiliconLabs/SimplicityStudio/v5/developer/sdks/8051/v4.2.3//kits
                    -/common/drivers/efm8_memory_lcd/inc;C:/SiliconLabs/SimplicityStudio/v5/developer/sdks/8051/v4.2.3//kits/common/drivers/e
                    -fm8_memory_lcd/inc/graphics;C:/SiliconLabs/SimplicityStudio/v5/developer/sdks/8051/v4.2.3//kits/common/drivers/efm8_memo
                    -ry_lcd/inc/config) PRINT(.\src\function_generator.lst) COND PAGEWIDTH(120) PAGELENGTH(65) OBJECT(.\src\function_generato
                    -r.OBJ)

line level    source

   1          /**************************************************************************//**
   2           * Copyright (c) 2015 by Silicon Laboratories Inc. All rights reserved.
   3           *
   4           * http://developer.silabs.com/legal/version/v11/Silicon_Labs_Software_License_Agreement.txt
   5           *****************************************************************************/
   6          ///////////////////////////////////////////////////////////////////////////////
   7          // function_generator.c
   8          ///////////////////////////////////////////////////////////////////////////////
   9          
  10          ///////////////////////////////////////////////////////////////////////////////
  11          // Call Graph
  12          //
  13          // FunctionGenerator_main()
  14          //  |
  15          //  +- drawSplash()
  16          //  |   +- getWaitJoystick()
  17          //  |   |   +- getJoystick()
  18          //  |
  19          //  +- drawStaticSprites()
  20          //  |   +- drawScreenSprite()
  21          //  |
  22          //  +- processInput()
  23          //  |   +- transitionDemoWaveform()
  24          //  |   +- transitionDemoFrequency()
  25          //  |
  26          //  +- drawScreen()
  27          //  |   +- drawScreenWaveform()
  28          //  |   +- drawScreenFrequency()
  29          //  |       +- drawScreenText()
  30          //  |
  31          //  +- synchFrame()
  32          //
  33          // Timer4_ISR()
  34          //
  35          // PORTMATCH_ISR()
  36          //
  37          
  38          ///////////////////////////////////////////////////////////////////////////////
  39          // Includes
  40          ///////////////////////////////////////////////////////////////////////////////
  41          
  42          #include "bsp.h"
C51 COMPILER V9.60.0.0   FUNCTION_GENERATOR                                                01/22/2022 21:08:33 PAGE 2   

  43          #include "tick.h"
  44          #include "render.h"
  45          #include "joystick.h"
  46          #include "thinfont.h"
  47          #include "function_generator.h"
  48          #include "sine.h"
  49          #include "square.h"
  50          #include "triangle.h"
  51          #include "sawtooth.h"
  52          #include "windowed_sine.h"
  53          #include "nav_up.h"
  54          #include "nav_down.h"
  55          #include "nav_left.h"
  56          #include "nav_right.h"
  57          #include "waveform_tables.h"
  58          #include "retargetserial.h"
  59          
  60          
  61          ///////////////////////////////////////////////////////////////////////////////
  62          // Globals
  63          ///////////////////////////////////////////////////////////////////////////////
  64          
  65          // Pins
  66          SI_SBIT(IN1, SFR_P1, 4);                  // P1.4 IN1
  67          //SI_SBIT(IN2, SFR_P1, 5);                  // P1.5 IN2
  68          //SI_SBIT(IN3, SFR_P1, 6);                  // P1.6 IN3
  69          
  70          // Demo state variables
  71          static DemoState currentDemoState = DEMO_SINE;
  72          static SI_VARIABLE_SEGMENT_POINTER(currentTable, uint16_t, const SI_SEG_CODE) = sineTable; // current wave
             -form table for DAC output
  73          static SI_VARIABLE_SEGMENT_POINTER(currentWaveform, uint8_t, const SI_SEG_CODE) = sine_bits; // current wa
             -veform picture
  74          
  75          // Frequency selection
  76          #define SUPPORTED_NUM_FREQ 8
  77          static SI_SEGMENT_VARIABLE(frequency[SUPPORTED_NUM_FREQ], uint16_t, SI_SEG_XDATA) = {
  78              10L,
  79              20L,
  80              50L,
  81              100L,
  82              200L,
  83              440L,
  84              1000L,
  85              2000L
  86          };
  87          
  88          // Current Frequency Selection
  89          static uint8_t currentFreqIndex = 3;
  90          
  91          // Phase offset (updated when frequency is changed)
  92          static uint16_t phaseOffset1 = 100 * PHASE_PRECISION / SAMPLE_RATE_DAC;
  93          //static uint16_t phaseOffset2 = 100 * PHASE_PRECISION / SAMPLE_RATE_DAC;
  94          //static uint16_t new_freq = 440;
  95          
  96          ///////////////////////////////////////////////////////////////////////////////
  97          // Supporting Functions
  98          ///////////////////////////////////////////////////////////////////////////////
  99          
 100          //-----------------------------------------------------------------------------
 101          // transitionDemoWaveform
 102          //-----------------------------------------------------------------------------
 103          //
C51 COMPILER V9.60.0.0   FUNCTION_GENERATOR                                                01/22/2022 21:08:33 PAGE 3   

 104          // Change function/waveform.
 105          // Left  - change function order: sine < square < triangle < sawtooth < windowed sine
 106          // Right - change function order: sine > square > triangle > sawtooth > windowed sine
 107          //
 108          // dir - valid arguments are: JOYSTICK_E, JOYSTICK_W
 109          //
 110          static void transitionDemoWaveform(uint8_t dir)
 111          {
 112   1        if (dir == JOYSTICK_E)
 113   1        {
 114   2          switch (currentDemoState)
 115   2          {
 116   3          case DEMO_SINE:
 117   3            currentDemoState = DEMO_SQUARE;
 118   3            currentWaveform = square_bits;
 119   3            currentTable = squareTable;
 120   3            break;
 121   3      
 122   3          case DEMO_SQUARE:
 123   3            currentDemoState = DEMO_TRIANGLE;
 124   3            currentWaveform = triangle_bits;
 125   3            currentTable = triangleTable;
 126   3            break;
 127   3      
 128   3          case DEMO_TRIANGLE:
 129   3                currentDemoState = DEMO_SAWTOOTH;
 130   3            currentWaveform = sawtooth_bits;
 131   3            currentTable = sawtoothTable;
 132   3            break;
 133   3      
 134   3          case DEMO_SAWTOOTH:
 135   3            currentDemoState = DEMO_WINDOWED_SINE;
 136   3            currentWaveform = windowed_sine_bits;
 137   3            currentTable = windowedSineTable;
 138   3            break;
 139   3      
 140   3          case DEMO_WINDOWED_SINE:
 141   3            currentDemoState = DEMO_SINE;
 142   3            currentWaveform = sine_bits;
 143   3            currentTable = sineTable;
 144   3            break;
 145   3          }
 146   2        }
 147   1        else if (dir == JOYSTICK_W)
 148   1        {
 149   2          switch (currentDemoState)
 150   2          {
 151   3          case DEMO_SINE:
 152   3            currentDemoState = DEMO_WINDOWED_SINE;
 153   3            currentWaveform = windowed_sine_bits;
 154   3            currentTable = windowedSineTable;
 155   3            break;
 156   3      
 157   3          case DEMO_SQUARE:
 158   3            currentDemoState = DEMO_SINE;
 159   3            currentWaveform = sine_bits;
 160   3            currentTable = sineTable;
 161   3            break;
 162   3      
 163   3          case DEMO_TRIANGLE:
 164   3            currentDemoState = DEMO_SQUARE;
 165   3            currentWaveform = square_bits;
 166   3            currentTable = squareTable;
C51 COMPILER V9.60.0.0   FUNCTION_GENERATOR                                                01/22/2022 21:08:33 PAGE 4   

 167   3            break;
 168   3      
 169   3          case DEMO_SAWTOOTH:
 170   3            currentDemoState = DEMO_TRIANGLE;
 171   3            currentWaveform = triangle_bits;
 172   3            currentTable = triangleTable;
 173   3            break;
 174   3      
 175   3          case DEMO_WINDOWED_SINE:
 176   3            currentDemoState = DEMO_SAWTOOTH;
 177   3            currentWaveform = sawtooth_bits;
 178   3            currentTable = sawtoothTable;
 179   3            break;
 180   3          }
 181   2        }
 182   1      }
 183          
 184          //-----------------------------------------------------------------------------
 185          // getJoystick
 186          //-----------------------------------------------------------------------------
 187          //
 188          // Get new ADC sample and return joystick direction. Valid return values:
 189          //  JOYSTICK_NONE   JOYSTICK_N   JOYSTICK_S
 190          //  JOYSTICK_C      JOYSTICK_E   JOYSTICK_W
 191          //
 192          static uint8_t getJoystick(void)
 193          {
 194   1        uint32_t mv;
 195   1        uint8_t dir;
 196   1      
 197   1        ADC0CN0_ADBUSY = 1;
 198   1        while (!ADC0CN0_ADINT);
 199   1        ADC0CN0_ADINT = 0;
 200   1      
 201   1        mv = ((uint32_t)ADC0) * 3300 / 1024;
 202   1      
 203   1        dir = JOYSTICK_convert_mv_to_direction(mv);
 204   1      
 205   1        return dir;
 206   1      }
 207          
 208          //-----------------------------------------------------------------------------
 209          // getWaitJoystick
 210          //-----------------------------------------------------------------------------
 211          //
 212          // Get joystick input. If joystick was moved, wait for release. Return joystick
 213          // direction. Valid return values:
 214          //  JOYSTICK_NONE   JOYSTICK_N   JOYSTICK_S
 215          //  JOYSTICK_C      JOYSTICK_E   JOYSTICK_W
 216          //
 217          static uint8_t getWaitJoystick(void)
 218          {
 219   1        uint8_t dir, dirSave;
 220   1      
 221   1        dir = getJoystick();
 222   1        dirSave = dir;
 223   1      
 224   1        // wait for release then transition
 225   1        while (dir != JOYSTICK_NONE)
 226   1        {
 227   2          dir = getJoystick();
 228   2        }
 229   1      
C51 COMPILER V9.60.0.0   FUNCTION_GENERATOR                                                01/22/2022 21:08:33 PAGE 5   

 230   1        return dirSave;
 231   1      }
 232          //
 233          static void processInput(uint8_t dir)
 234          {
 235   1        if ((dir == JOYSTICK_E) || (dir == JOYSTICK_W))
 236   1          {
 237   2            transitionDemoWaveform(dir);
 238   2          }
 239   1        if (IN1 == 1){
 240   2            currentFreqIndex = 4;
 241   2            phaseOffset1 = frequency[currentFreqIndex] * PHASE_PRECISION / SAMPLE_RATE_DAC;
 242   2        }
 243   1        else if (IN1 == 0){
 244   2            currentFreqIndex = 5;
 245   2            phaseOffset1 = frequency[currentFreqIndex] * PHASE_PRECISION / SAMPLE_RATE_DAC;
 246   2        }
 247   1      }
 248          
 249          
 250          ///////////////////////////////////////////////////////////////////////////////
 251          // Interrupt Service Routines
 252          ///////////////////////////////////////////////////////////////////////////////
 253          
 254          SI_INTERRUPT_USING(TIMER4_ISR, TIMER4_IRQn, 1)
 255          {
 256   1        static uint16_t phaseAcc1 = 0;       // Holds phase accumulator
 257   1        //static uint16_t phaseAcc2 = 0;       // Holds phase accumulator
 258   1      
 259   1        SI_UU16_t temp;   // The temporary value that holds
 260   1                          // value before being written
 261   1                          // to the DAC
 262   1        
 263   1        TMR4CN0 &= ~TMR3CN0_TF3H__BMASK;    // Clear Timer4 overflow flag
 264   1      
 265   1        phaseAcc1 += phaseOffset1;            // Increment phase accumulator
 266   1        //phaseAcc2 += phaseOffset2;            // Increment phase accumulator
 267   1      
 268   1        // Read the table value
 269   1        temp.u16 = currentTable[phaseAcc1 >> 8];
 270   1      
 271   1        // Set the value of <temp> to the next output of DAC at full-scale
 272   1        // amplitude. The rails are 0x000 and 0xFFF. DAC low byte must be
 273   1        // written first.
 274   1        SFRPAGE = PG4_PAGE;
 275   1      
 276   1      
 277   1        DAC3L = DAC2L = DAC1L = DAC0L = temp.u8[LSB];
 278   1        DAC3H = DAC2H = DAC1H = DAC0H = temp.u8[MSB];
 279   1      }
 280          
 281          ///////////////////////////////////////////////////////////////////////////////
 282          // Driver Function
 283          ///////////////////////////////////////////////////////////////////////////////
 284          
 285          void FunctionGenerator_main(void)
 286          {
 287   1        while(1)
 288   1        {
 289   2          processInput(getWaitJoystick());
 290   2        }
 291   1      }

C51 COMPILER V9.60.0.0   FUNCTION_GENERATOR                                                01/22/2022 21:08:33 PAGE 6   


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    352    ----
   CONSTANT SIZE    =   8218    ----
   XDATA SIZE       =     16    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     10       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
